<div class="currently-playing-container">
    <!-- Back Navigation Arrow -->
    <a routerLink="/dashboard" class="back-arrow-btn" title="Volver al Dashboard">
        <span class="material-icons">arrow_back</span>
    </a>

    <!-- Header Section -->
    <header class="header">
        <div class="title-section">
            <h1 class="page-title">
                Jugando actualmente
            </h1>
            @if (hasGames()) {
            <div class="stats-pills">
                <span class="stat-pill">
                    <span class="stat-value">{{ filteredGames().length }}</span>
                    <span class="stat-label">juegos</span>
                </span>
                <span class="stat-pill highlight">
                    <span class="stat-icon">‚è±Ô∏è</span>
                    <span class="stat-value">{{ totalHours() }}h</span>
                    <span class="stat-label">jugadas</span>
                </span>
            </div>
            }
        </div>

        <button class="refresh-btn" (click)="refreshGames()" [disabled]="loading()">
            <span class="material-icons" [class.spinning]="loading()">refresh</span>
            <span class="btn-text">Actualizar</span>
        </button>
    </header>

    <!-- Filters Section -->
    @if (!loading() && !error() && hasGames()) {
    <section class="filters-section">
        <div class="search-bar">
            <span class="material-icons search-icon">search</span>
            <input type="text" placeholder="Buscar juegos..." [ngModel]="searchTerm()"
                (ngModelChange)="updateSearchTerm($event)">
            @if (searchTerm()) {
            <button class="clear-search" (click)="updateSearchTerm('')">
                <span class="material-icons">close</span>
            </button>
            }
        </div>

        <div class="filter-groups">
            <!-- Genre Filter -->
            <div class="filter-group">
                <span class="filter-label">G√©nero</span>
                <div class="chips-scroll">
                    @for (genre of uniqueGenres(); track genre) {
                    <button type="button" class="filter-chip" [class.active]="activeGenre() === genre"
                        (click)="filterByGenre(genre || 'All')">
                        {{ genre }}
                    </button>
                    }
                </div>
            </div>

            <!-- Platform Filter -->
            @if (uniquePlatforms().length > 2) {
            <div class="filter-group">
                <span class="filter-label">Plataforma</span>
                <div class="chips-scroll">
                    @for (platform of uniquePlatforms(); track platform) {
                    <button type="button" class="filter-chip" [class.active]="activePlatform() === platform"
                        (click)="filterByPlatform(platform || 'All')">
                        {{ platform }}
                    </button>
                    }
                </div>
            </div>
            }
        </div>

        @if (getActiveFiltersCount() > 0) {
        <button class="reset-filters-btn" (click)="resetFilters()">
            <span class="material-icons">filter_alt_off</span>
            Limpiar filtros ({{ getActiveFiltersCount() }})
        </button>
        }
    </section>
    }

    <!-- Loading State -->
    @if (loading()) {
    <div class="state-container loading">
        <div class="loading-spinner"></div>
        <p>Cargando juegos en progreso...</p>
    </div>
    }

    <!-- Error State -->
    @if (error() && !loading()) {
    <div class="state-container error">
        <span class="state-icon">‚ö†Ô∏è</span>
        <h3>Error al cargar los datos</h3>
        <p>{{ error() }}</p>
        <button class="action-btn" (click)="refreshGames()">
            <span class="material-icons">refresh</span>
            Reintentar
        </button>
    </div>
    }

    <!-- Empty State - No games -->
    @if (!loading() && !error() && !hasGames()) {
    <div class="state-container empty">
        <span class="state-icon">üéØ</span>
        <h3>No hay juegos en progreso</h3>
        <p>Cuando marques un juego como "jugando actualmente" desde el detalle del juego, aparecer√° aqu√≠.</p>
        <a routerLink="/dashboard" class="action-btn primary">
            <span class="material-icons">sports_esports</span>
            Ir a mi biblioteca
        </a>
    </div>
    }

    <!-- Empty State - No filtered results -->
    @if (!loading() && !error() && hasGames() && !hasFilteredGames()) {
    <div class="state-container empty">
        <span class="state-icon">üîç</span>
        <h3>Sin resultados</h3>
        <p>No hay juegos que coincidan con los filtros aplicados.</p>
        <button class="action-btn" (click)="resetFilters()">
            <span class="material-icons">filter_alt_off</span>
            Limpiar filtros
        </button>
    </div>
    }

    <!-- Games Content -->
    @if (!loading() && !error() && hasFilteredGames()) {
    <main class="games-content">
        <!-- Single platform view -->
        @if (!hasMultiplePlatforms()) {
        <div class="games-grid">
            @for (game of filteredGames(); track game.id) {
            <article class="game-card">
                <div class="card-image">
                    <img [src]="game.image_url" [alt]="game.name"
                        onerror="this.src='/assets/images/placeholder-game.png'">
                    <a class="quick-view" [routerLink]="['/game', game.id]">
                        <span class="material-icons">visibility</span>
                    </a>
                </div>

                <div class="card-body">
                    <h3 class="game-name">{{ game.name }}</h3>

                    <div class="game-tags">
                        @if (game.genre) {
                        <span class="tag genre">{{ game.genre }}</span>
                        }
                        @if (game.platform) {
                        <span class="tag platform">{{ game.platform }}</span>
                        }
                    </div>

                    <!-- Hours Section -->
                    <div class="hours-tracker">
                        @if (editingHours() !== game.id) {
                        <div class="hours-display">
                            <span class="hours-icon">‚è±Ô∏è</span>
                            <span class="hours-text">
                                <span class="hours-value">{{ formatHours(game.hours_played || 0) }}</span>
                            </span>
                            @if (!isReadOnlyUser()) {
                            <button class="edit-btn" (click)="startEditingHours(game.id!, game.hours_played || 0)">
                                <span class="material-icons">edit</span>
                            </button>
                            }
                        </div>
                        } @else {
                        <div class="hours-edit">
                            <input type="number" [id]="'hours-' + game.id" min="0" step="0.5" [ngModel]="tempHours()"
                                (ngModelChange)="updateTempHours($event)" placeholder="Horas">
                            <div class="edit-actions">
                                <button class="save-btn" (click)="saveHours(game)">
                                    <span class="material-icons">check</span>
                                </button>
                                <button class="cancel-btn" (click)="cancelEditingHours()">
                                    <span class="material-icons">close</span>
                                </button>
                            </div>
                        </div>
                        }
                    </div>

                    <!-- Actions -->
                    <div class="card-actions">
                        @if (!isReadOnlyUser()) {
                        <button class="btn-pause" (click)="toggleCurrentlyPlaying(game)">
                            <span class="material-icons">pause</span>
                            Pausar
                        </button>
                        }
                        <a class="btn-view" [routerLink]="['/game', game.id]">
                            <span class="material-icons">info</span>
                            Detalles
                        </a>
                    </div>
                </div>
            </article>
            }
        </div>
        } @else {
        <!-- Multiple platforms view -->
        <div class="platforms-list">
            @for (platformGroup of gamesByPlatform(); track platformGroup.platform) {
            <section class="platform-group" [ngClass]="getPlatformClass(platformGroup.platform)">
                <header class="platform-header">
                    <img [src]="getPlatformIcon(platformGroup.platform)" [alt]="platformGroup.platform" class="platform-icon" [title]="platformGroup.platform">
                    <h2 class="platform-name">{{ platformGroup.platform }}</h2>
                    <div class="platform-meta">
                        <span class="count">{{ platformGroup.games.length }} juego{{ platformGroup.games.length !== 1 ?
                            's' : '' }}</span>
                        <span class="divider">‚Ä¢</span>
                        <span class="hours">{{ formatHours(getPlatformHours(platformGroup.platform)) }}</span>
                    </div>
                </header>

                <div class="games-grid">
                    @for (game of platformGroup.games; track game.id) {
                    <article class="game-card">
                        <div class="card-image">
                            <img [src]="game.image_url" [alt]="game.name"
                                onerror="this.src='/assets/images/placeholder-game.png'">
                            <a class="quick-view" [routerLink]="['/game', game.id]">
                                <span class="material-icons">visibility</span>
                            </a>
                        </div>

                        <div class="card-body">
                            <h3 class="game-name">{{ game.name }}</h3>

                            <div class="game-tags">
                                @if (game.genre) {
                                <span class="tag genre">{{ game.genre }}</span>
                                }
                            </div>

                            <!-- Hours Section -->
                            <div class="hours-tracker">
                                @if (editingHours() !== game.id) {
                                <div class="hours-display">
                                    <span class="hours-icon">‚è±Ô∏è</span>
                                    <span class="hours-text">
                                        <span class="hours-value">{{ formatHours(game.hours_played || 0) }}</span>
                                    </span>
                                    @if (!isReadOnlyUser()) {
                                    <button class="edit-btn"
                                        (click)="startEditingHours(game.id!, game.hours_played || 0)">
                                        <span class="material-icons">edit</span>
                                    </button>
                                    }
                                </div>
                                } @else {
                                <div class="hours-edit">
                                    <input type="number" [id]="'hours-' + game.id" min="0" step="0.5"
                                        [ngModel]="tempHours()" (ngModelChange)="updateTempHours($event)"
                                        placeholder="Horas">
                                    <div class="edit-actions">
                                        <button class="save-btn" (click)="saveHours(game)">
                                            <span class="material-icons">check</span>
                                        </button>
                                        <button class="cancel-btn" (click)="cancelEditingHours()">
                                            <span class="material-icons">close</span>
                                        </button>
                                    </div>
                                </div>
                                }
                            </div>

                            <!-- Actions -->
                            <div class="card-actions">
                                @if (!isReadOnlyUser()) {
                                <button class="btn-pause" (click)="toggleCurrentlyPlaying(game)">
                                    <span class="material-icons">pause</span>
                                    Pausar
                                </button>
                                }
                                <a class="btn-view" [routerLink]="['/game', game.id]">
                                    <span class="material-icons">info</span>
                                    Detalles
                                </a>
                            </div>
                        </div>
                    </article>
                    }
                </div>
            </section>
            }
        </div>
        }
    </main>
    }
</div>